name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Laravel Backend
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            echo "ðŸ“¦ Navigating to application directory..."
            cd ${{ secrets.APP_PATH || '/var/www/aegis-ignis' }}
            
            echo "ðŸ”„ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ“ Installing Composer dependencies..."
            cd backend-laravel
            composer install --no-dev --optimize-autoloader
            
            echo "âš™ï¸ Running migrations..."
            php artisan migrate --force
            
            echo "ðŸ§¹ Clearing caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "ðŸ“¦ Optimizing application..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "ðŸ”‘ Setting permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            echo "ðŸ”„ Restarting services..."
            sudo systemctl restart php8.2-fpm
            sudo systemctl restart nginx
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Deploy Fire Detection Service
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            echo "ðŸ”¥ Deploying Fire Detection Service..."
            cd ${{ secrets.APP_PATH || '/var/www/aegis-ignis' }}
            
            # Install Python dependencies
            cd fire-detection-service
            pip3 install -r requirements.txt
            
            # Restart fire detection service
            sudo systemctl restart fire-detection || echo "Fire detection service not configured as systemd service"
            
            echo "âœ… Fire Detection Service deployed!"
          EOF

      - name: Deploy Face Recognition Service
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            echo "ðŸ‘¤ Deploying Face Recognition Service..."
            cd ${{ secrets.APP_PATH || '/var/www/aegis-ignis' }}
            
            # Install Python dependencies
            cd python-face-service
            pip3 install -r requirements.txt
            
            # Restart face service
            sudo systemctl restart face-service || echo "Face service not configured as systemd service"
            
            echo "âœ… Face Recognition Service deployed!"
          EOF

      - name: Deploy Frontend Dashboard
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            echo "ðŸŽ¨ Deploying Frontend Dashboard..."
            cd ${{ secrets.APP_PATH || '/var/www/aegis-ignis' }}
            cd "Smart Building Dashboard Design"
            
            # Install dependencies and build
            npm install
            npm run build
            
            echo "âœ… Frontend Dashboard deployed!"
          EOF

      - name: Deployment Summary
        if: success()
        run: |
          echo "ðŸŽ‰ All services deployed successfully!"
          echo "- Laravel Backend âœ…"
          echo "- Fire Detection Service âœ…"
          echo "- Face Recognition Service âœ…"
          echo "- Frontend Dashboard âœ…"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Please check the logs above."
